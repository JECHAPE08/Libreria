@model List<Biblioteca.Models.Usuario>

@{
    ViewBag.Title = "Gestión de Usuarios";
    Layout = "~/Views/Shared/_LayoutAdministrador.cshtml";
}
<link rel="stylesheet" href="~/Content/Administrador/index.css" />
<link rel="stylesheet" href="~/Content/Administrador/modals.css" />
<link rel="stylesheet" href="~/Content/Administrador/Usuarios/Index.css" />


<div class="dashboard-container">
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Usuarios</h1>
            <p class="dashboard-subtitle">Administra los usuarios registrados</p>
        </div>
        <div class="dashboard-actions">
            <button class="btn btn-primary" onclick="toggleModal('usuarioModal')">
                <i class="fas fa-user-plus"></i> Nuevo Usuario
            </button>
        </div>
    </header>

    <section class="dashboard-content">
        <div class="search-container">
            <form method="get" action="/AdministradorUsuarios/Index" role="search">
                <input type="text" name="busqueda" placeholder="Buscar usuarios..." value="@Request.QueryString["search"]" aria-label="Buscar usuarios">
                <button type="submit" class="search-button" aria-label="Buscar">
                    <i class="fas fa-search"></i>
                </button>
            </form>
        </div>

        @if (Model != null && Model.Any())
        {
            <div class="usuario-list">
                @foreach (var usuario in Model)
                {
                    <div class="usuario-item">
                        <div class="usuario-info">
                            <h3>@usuario.Nombre</h3>
                            <p class="usuario-preview">
                                Biblioteca: @(usuario.Biblioteca != null ? usuario.Biblioteca.Nombre : "Sin asignar")
                            </p>
                            <p class="usuario-preview">
                                Rol: @usuario.RolUsuario.Nombre
                            </p>
                        </div>
                        <div class="usuario-actions">
                            <a class="btn btn-edit"
                               onclick="openEditUsuarioModal({
                                   ID: @usuario.ID,
                                   Nombre: '@usuario.Nombre',
                                   Correo: '@usuario.Correo',
                                   RolID: '@usuario.RolID',
                                   BibliotecaID: '@usuario.BibliotecaID'
                               });">
                                Editar
                            </a>


                            <form method="post" action="@Url.Action("Delete", "AdministradorUsuarios", new { id = usuario.ID })"
                                  onsubmit="return confirm('¿Confirmar eliminación de este usuario?');"
                                  onclick="event.stopPropagation();">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-delete">Eliminar</button>
                            </form>
                        </div>
                    </div>

                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <i class="fas fa-user-slash"></i>
                <h3>No se encontraron usuarios</h3>
                <p>No hay usuarios registrados en el sistema</p>
                <button class="btn btn-primary" onclick="toggleModal('usuarioModal')">
                    <i class="fas fa-user-plus"></i> Crear usuario
                </button>
            </div>
        }
    </section>
</div>

<!-- Modal para Nuevo Usuario -->
<div class="modal-overlay" id="usuarioModal">
    <div class="modal-form">
        <button class="close-btn" onclick="toggleModal('usuarioModal')">✖</button>
        <h2>Crear Usuario</h2>
        <form method="post" action="/AdministradorUsuarios/Create">
            @Html.AntiForgeryToken()

            <div class="form-group">
                <label for="Nombre">Nombre del Usuario</label>
                <input type="text" id="Nombre" name="Nombre" required>
            </div>

            <div class="form-group">
                <label for="Correo">Correo Electrónico</label>
                <input type="email" id="Correo" name="Correo" required>
            </div>

            <div class="form-group">
                <label for="Contrasena">Contraseña</label>
                <input type="password" id="Contrasena" name="Contrasena" required>
            </div>

            <div class="form-group">
                <label for="BibliotecaID">Biblioteca Asignada</label>
                <select id="BibliotecaID" name="BibliotecaID" required>
                    <option value="">-- Seleccione una biblioteca --</option>
                    @foreach (var biblioteca in ViewBag.Bibliotecas)
                    {
                        <option value="@biblioteca.ID">@biblioteca.Nombre</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label for="RolID">Rol del Usuario</label>
                <select id="RolID" name="RolID" required>
                    <option value="">-- Seleccione un rol --</option>
                    @foreach (var rol in ViewBag.Roles)
                    {
                        <option value="@rol.ID">@rol.Nombre</option>
                    }
                </select>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="toggleModal('usuarioModal')">Cancelar</button>
                <button type="submit" class="btn btn-success">Guardar</button>
            </div>
        </form>
    </div>
</div>


<!-- Modal para Editar Usuario -->
<div class="modal-overlay" id="EditarUsuario">
    <div class="modal-form">
        <button class="close-btn" onclick="closeForm('EditarUsuario')">✖</button>
        <h2>Editar Usuario</h2>
        <form method="post" action="/AdministradorUsuarios/Edit">
            @Html.AntiForgeryToken()
            <input type="hidden" id="editId" name="ID" />
            <div class="form-group">
                <label for="editNombre">Nombre del Usuario</label>
                <input type="text" id="editNombre" name="Nombre" required />
            </div>
            <div class="form-group">
                <label for="editEmail">Correo Electrónico</label>
                <input type="email" id="editEmail" name="Correo" required />
            </div>
            <div class="form-group">
                <label for="editBibliotecaID">Biblioteca Asignada</label>
                <select id="editBibliotecaID" name="BibliotecaID">
                    <option value="">-- Seleccione una biblioteca --</option>
                    @foreach (var biblioteca in ViewBag.Bibliotecas)
                    {
                        <option value="@biblioteca.ID">@biblioteca.Nombre</option>
                    }
                </select>
            </div>
            <div class="form-group">
                <label for="editRol">Rol del Usuario</label>
                <select id="editRol" name="RolID" required>
                    @foreach (var rol in ViewBag.Roles)
                    {
                        <option value="@rol.ID">@rol.Nombre</option>
                    }
                </select>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeForm('EditarUsuario')">Cancelar</button>
                <button type="submit" class="btn btn-success">Guardar</button>
            </div>
        </form>
    </div>
</div>

<script src="~/Scripts/vistas/vistas.js"></script>

<script>
    function openEditUsuarioModal(usuario) {
        document.getElementById('editId').value = usuario.ID;
        document.getElementById('editNombre').value = usuario.Nombre;
        document.getElementById('editEmail').value = usuario.Correo;
        document.getElementById('editRol').value = usuario.RolID;  // Se asigna RolID al select
        document.getElementById('editBibliotecaID').value = usuario.BibliotecaID;

        document.getElementById('EditarUsuario').style.display = 'flex';
    }
</script>